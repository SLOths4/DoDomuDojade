<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 20px;
        }

        :root {
            --color-background: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1f2121;
            --color-primary: #2180 8d;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-border: #e5e7eb;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        header h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 14px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--color-success);
        }

        .status-indicator.disconnected {
            background: var(--color-error);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--color-primary);
        }

        .card-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .list-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--color-warning);
        }

        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-error);
        }

        .badge-info {
            background: rgba(33, 128, 141, 0.2);
            color: var(--color-primary);
        }

        .event-log {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .event-log-item {
            padding: 8px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-left: 3px solid var(--color-primary);
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .event-log-item.new {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timestamp {
            color: #999;
            font-size: 12px;
        }

        button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #1a6f7d;
        }

        button:active {
            transform: scale(0.98);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .loading {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            animation: blink 1.4s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üöÄ Display Dashboard (SSE)</h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator disconnected" id="sse-status"></div>
                <span id="sse-text">Roz≈ÇƒÖczono</span>
            </div>
            <div class="status-item">
                <span id="last-update">Ostatnia aktualizacja: nigdy</span>
            </div>
            <div class="status-item">
                <span id="event-count">Zdarze≈Ñ: 0</span>
            </div>
        </div>
    </header>

    <div class="button-group">
        <button id="connect-btn" onclick="connectSSE()">üîå Po≈ÇƒÖcz SSE</button>
        <button id="disconnect-btn" onclick="disconnectSSE()" disabled>üîå Roz≈ÇƒÖcz</button>
        <button onclick="refreshAllData()">üîÑ Od≈õwie≈º wszystkie dane</button>
    </div>

    <!-- Karty danych -->
    <div class="grid">
        <!-- Odjazdy -->
        <div class="card">
            <h2>üöå Odjazdy</h2>
            <div id="departures" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>

        <!-- Og≈Çoszenia -->
        <div class="card">
            <h2>üì¢ Og≈Çoszenia</h2>
            <div id="announcements" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>

        <!-- Pogoda -->
        <div class="card">
            <h2>üå§Ô∏è Pogoda</h2>
            <div id="weather" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>

        <!-- Licznik -->
        <div class="card">
            <h2>‚è±Ô∏è Licznik</h2>
            <div id="countdown" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>

        <!-- Eventy -->
        <div class="card">
            <h2>üìÖ Eventy</h2>
            <div id="events" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>

        <!-- Cytat -->
        <div class="card">
            <h2>üí≠ Cytat</h2>
            <div id="quote" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>

        <!-- S≈Çowo dnia -->
        <div class="card">
            <h2>üìñ S≈Çowo Dnia</h2>
            <div id="word" class="card-content">
                <p>≈Åadowanie...</p>
            </div>
        </div>
    </div>

    <!-- Event Log -->
    <div class="card">
        <h2>üìã Log Zdarze≈Ñ SSE</h2>
        <div id="event-log" class="event-log"></div>
    </div>
</div>

<script>
    // ==================== KONFIGURACJA ====================
    const CONFIG = {
        BASE_URL: 'http://localhost:8888', // zmie≈Ñ na sw√≥j endpoint
        SSE_ENDPOINT: 'http://localhost:8888/stream', // endpoint SSE
        API_ENDPOINTS: {
            departures: '/display/get_departures',
            announcements: '/display/get_announcements',
            weather: '/display/get_weather',
            countdown: '/display/get_countdown',
            events: '/display/get_events',
            quote: '/display/get_quote',
            word: '/display/get_word'
        }
    };

    // ==================== STATE ====================
    let sseConnection = null;
    let eventCount = 0;
    let data = {
        departures: [],
        announcements: [],
        weather: {},
        countdown: {},
        events: [],
        quote: {},
        word: {}
    };

    // ==================== INICJALIZACJA ====================
    document.addEventListener('DOMContentLoaded', () => {
        loadAllData();
    });

    // ==================== POBIERANIE DANYCH ====================
    async function loadAllData() {
        try {
            await Promise.all([
                loadDepartures(),
                loadAnnouncements(),
                loadWeather(),
                loadCountdown(),
                loadEvents(),
                loadQuote(),
                loadWord()
            ]);
        } catch (error) {
            console.error('B≈ÇƒÖd przy ≈Çadowaniu danych:', error);
            logEvent('ERROR', `B≈ÇƒÖd ≈Çadowania: ${error.message}`);
        }
    }

    async function loadDepartures() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.departures);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.departures = result.data?.departures || [];
            renderDepartures();
            logEvent('LOAD', 'Odjazdy za≈Çadowane');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania odjazd√≥w:', error);
            document.getElementById('departures').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function loadWeather() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.weather);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.weather = result.data || {};
            renderWeather();
            logEvent('LOAD', 'Pogoda za≈Çadowana');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania pogody:', error);
            document.getElementById('weather').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function loadCountdown() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.countdown);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.countdown = result.data || {};
            renderCountdown();
            logEvent('LOAD', 'Licznik za≈Çadowany');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania licznika:', error);
            document.getElementById('countdown').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function loadEvents() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.events);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.events = result.data?.events || [];
            renderEvents();
            logEvent('LOAD', 'Eventy za≈Çadowane');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania event√≥w:', error);
            document.getElementById('events').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function loadQuote() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.quote);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.quote = result.data || {};
            renderQuote();
            logEvent('LOAD', 'Cytat za≈Çadowany');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania cytatu:', error);
            document.getElementById('quote').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function loadWord() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.word);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.word = result.data || {};
            renderWord();
            logEvent('LOAD', 'S≈Çowo za≈Çadowane');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania s≈Çowa:', error);
            document.getElementById('word').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function loadAnnouncements() {
        try {
            const response = await fetch(CONFIG.BASE_URL + CONFIG.API_ENDPOINTS.announcements);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            data.announcements = result.data?.announcements || [];
            renderAnnouncements();
            logEvent('LOAD', 'Og≈Çoszenia za≈Çadowane');
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania og≈Çosze≈Ñ:', error);
            document.getElementById('announcements').innerHTML =
                `<p style="color: var(--color-error)">‚ùå B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    // ==================== SSE CONNECTION ====================
    function connectSSE() {
        if (sseConnection) {
            console.warn('SSE ju≈º po≈ÇƒÖczone');
            return;
        }

        try {
            sseConnection = new EventSource(CONFIG.SSE_ENDPOINT);

            sseConnection.addEventListener('open', () => {
                updateSSEStatus(true);
                logEvent('SSE', '‚úÖ Po≈ÇƒÖczenie SSE nawiƒÖzane');
            });

            // Listener dla og√≥lnych wiadomo≈õci
            sseConnection.addEventListener('message', (event) => {
                handleSSEMessage(event.data);
            });

            // Listener dla ojazd√≥w
            sseConnection.addEventListener('departures_updated', () => {
                logEvent('EVENT', 'üöå departures_updated');
                loadDepartures();
            });

            // Listener dla og≈Çosze≈Ñ
            sseConnection.addEventListener('announcements_updated', () => {
                logEvent('EVENT', 'üì¢ announcements_updated');
                loadAnnouncements();
            });

            // Listener dla pogody
            sseConnection.addEventListener('weather_updated', () => {
                logEvent('EVENT', 'üå§Ô∏è weather_updated');
                loadWeather();
            });

            // Listener dla licznika
            sseConnection.addEventListener('countdown_updated', () => {
                logEvent('EVENT', '‚è±Ô∏è countdown_updated');
                loadCountdown();
            });

            // Listener dla event√≥w
            sseConnection.addEventListener('events_updated', () => {
                logEvent('EVENT', 'üìÖ events_updated');
                loadEvents();
            });

            // Listener dla cytatu
            sseConnection.addEventListener('quote_updated', () => {
                logEvent('EVENT', 'üí≠ quote_updated');
                loadQuote();
            });

            // Listener dla s≈Çowa
            sseConnection.addEventListener('word_updated', () => {
                logEvent('EVENT', 'üìñ word_updated');
                loadWord();
            });

            // Listener dla b≈Çƒôd√≥w
            sseConnection.addEventListener('error', (event) => {
                console.error('SSE Error:', event);
                updateSSEStatus(false);
                logEvent('ERROR', '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia SSE');
            });

        } catch (error) {
            console.error('B≈ÇƒÖd po≈ÇƒÖczenia SSE:', error);
            logEvent('ERROR', `B≈ÇƒÖd SSE: ${error.message}`);
            updateSSEStatus(false);
        }
    }

    function disconnectSSE() {
        if (sseConnection) {
            sseConnection.close();
            sseConnection = null;
            updateSSEStatus(false);
            logEvent('SSE', '‚ùå Po≈ÇƒÖczenie SSE roz≈ÇƒÖczone');
        }
    }

    // ==================== OBS≈ÅUGA ZDARZE≈É SSE ====================
    function handleSSEMessage(data) {
        try {
            const event = JSON.parse(data);
            logEvent('MESSAGE', JSON.stringify(event).substring(0, 100));
            eventCount++;
            updateEventCount();
        } catch (error) {
            logEvent('MESSAGE', data.substring(0, 100));
        }
    }

    // ==================== RENDEROWANIE UI ====================
    function renderDepartures() {
        const container = document.getElementById('departures');

        if (!data.departures || data.departures.length === 0) {
            container.innerHTML = '<p>Brak odjazd√≥w</p>';
            return;
        }

        container.innerHTML = data.departures.slice(0, 8).map(dep => `
                <div class="list-item">
                    <div>
                        <strong style="font-size: 16px;">${dep.line}</strong>
                        <p style="font-size: 12px; color: #999; margin-top: 4px;">
                            ${dep.direction}
                        </p>
                    </div>
                    <span class="badge badge-warning">${dep.minutes} min</span>
                </div>
            `).join('');

        updateTimestamp();
    }

    function renderAnnouncements() {
        const container = document.getElementById('announcements');

        if (!data.announcements || data.announcements.length === 0) {
            container.innerHTML = '<p>Brak og≈Çosze≈Ñ</p>';
            return;
        }

        container.innerHTML = data.announcements.slice(0, 5).map(item => `
                <div class="list-item">
                    <div>
                        <strong>${item.title || 'Bez tytu≈Çu'}</strong>
                        <p style="font-size: 12px; color: #999; margin-top: 4px;">
                            ${item.text || item.description || ''}
                        </p>
                        <p style="font-size: 11px; color: #bbb; margin-top: 3px;">
                            ~ ${item.author || 'Nieznany'}
                        </p>
                    </div>
                </div>
            `).join('');

        updateTimestamp();
    }

    function renderWeather() {
        const container = document.getElementById('weather');
        const weather = data.weather;

        if (!weather || Object.keys(weather).length === 0) {
            container.innerHTML = '<p>Brak danych pogody</p>';
            return;
        }

        container.innerHTML = `
                ${weather.temperature ? `
                <div class="list-item">
                    <strong>Temperatura:</strong>
                    <span>${weather.temperature}¬∞C</span>
                </div>
                ` : ''}
                ${weather.condition ? `
                <div class="list-item">
                    <strong>Warunki:</strong>
                    <span>${weather.condition}</span>
                </div>
                ` : ''}
                ${weather.humidity ? `
                <div class="list-item">
                    <strong>Wilgotno≈õƒá:</strong>
                    <span>${weather.humidity}%</span>
                </div>
                ` : ''}
                ${weather.wind_speed ? `
                <div class="list-item">
                    <strong>Wiatr:</strong>
                    <span>${weather.wind_speed} km/h</span>
                </div>
                ` : ''}
            `;

        updateTimestamp();
    }

    function renderCountdown() {
        const container = document.getElementById('countdown');
        const countdown = data.countdown;

        if (!countdown || Object.keys(countdown).length === 0) {
            container.innerHTML = '<p>Brak danych licznika</p>';
            return;
        }

        container.innerHTML = `
                ${countdown.event ? `
                <div class="list-item">
                    <strong>Event:</strong>
                    <span>${countdown.event}</span>
                </div>
                ` : ''}
                ${countdown.remaining_time ? `
                <div class="list-item">
                    <strong style="font-size: 18px; color: var(--color-primary);">
                        ${countdown.remaining_time}
                    </strong>
                </div>
                ` : ''}
                ${countdown.date ? `
                <div class="list-item">
                    <strong>Data:</strong>
                    <span>${countdown.date}</span>
                </div>
                ` : ''}
            `;

        updateTimestamp();
    }

    function renderEvents() {
        const container = document.getElementById('events');

        if (!data.events || data.events.length === 0) {
            container.innerHTML = '<p>Brak event√≥w</p>';
            return;
        }

        container.innerHTML = data.events.slice(0, 5).map(event => `
                <div class="list-item">
                    <div>
                        <strong>${event.name || event.title || 'Bez nazwy'}</strong>
                        <p style="font-size: 12px; color: #999; margin-top: 4px;">
                            ${event.description || event.date || ''}
                        </p>
                    </div>
                    <span class="badge badge-info">${event.date || event.time || 'soon'}</span>
                </div>
            `).join('');

        updateTimestamp();
    }

    function renderQuote() {
        const container = document.getElementById('quote');
        const quote = data.quote;

        if (!quote || (!quote.text && !quote.quote)) {
            container.innerHTML = '<p>Brak cytatu</p>';
            return;
        }

        container.innerHTML = `
                <div style="padding: 15px; background: #f9f9f9; border-radius: 6px; border-left: 3px solid var(--color-primary);">
                    <p style="font-style: italic; margin-bottom: 10px; line-height: 1.6;">
                        "${quote.text || quote.quote}"
                    </p>
                    ${quote.author ? `
                    <p style="font-size: 12px; color: #999; text-align: right;">
                        ‚Äî ${quote.author}
                    </p>
                    ` : ''}
                </div>
            `;

        updateTimestamp();
    }

    function renderWord() {
        const container = document.getElementById('word');
        const word = data.word;

        if (!word || (!word.word && !word.text)) {
            container.innerHTML = '<p>Brak s≈Çowa</p>';
            return;
        }

        container.innerHTML = `
                <div class="list-item">
                    <strong style="font-size: 18px; color: var(--color-primary);">
                        ${word.word || word.text}
                    </strong>
                </div>
                ${word.definition ? `
                <div class="list-item">
                    <p style="font-size: 13px; line-height: 1.5;">
                        ${word.definition}
                    </p>
                </div>
                ` : ''}
                ${word.pronunciation ? `
                <div class="list-item">
                    <strong>Wymowa:</strong>
                    <span>${word.pronunciation}</span>
                </div>
                ` : ''}
                ${word.example ? `
                <div class="list-item">
                    <strong>Przyk≈Çad:</strong>
                    <p style="font-size: 12px; color: #999; margin-top: 4px;">
                        ${word.example}
                    </p>
                </div>
                ` : ''}
            `;

        updateTimestamp();
    }

    // ==================== UTILITY FUNCTIONS ====================
    function updateSSEStatus(connected) {
        const indicator = document.getElementById('sse-status');
        const text = document.getElementById('sse-text');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');

        if (connected) {
            indicator.className = 'status-indicator connected';
            text.textContent = 'Po≈ÇƒÖczono';
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
        } else {
            indicator.className = 'status-indicator disconnected';
            text.textContent = 'Roz≈ÇƒÖczono';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
        }
    }

    function updateTimestamp() {
        const now = new Date().toLocaleTimeString('pl-PL');
        document.getElementById('last-update').textContent = `Ostatnia aktualizacja: ${now}`;
    }

    function updateEventCount() {
        document.getElementById('event-count').textContent = `Zdarze≈Ñ: ${eventCount}`;
    }

    function logEvent(type, message) {
        const log = document.getElementById('event-log');
        const item = document.createElement('div');
        item.className = 'event-log-item new';
        const time = new Date().toLocaleTimeString('pl-PL');
        item.innerHTML = `
                <span class="timestamp">[${time}]</span>
                <strong>${type}:</strong> ${sanitizeHTML(message)}
            `;
        log.insertBefore(item, log.firstChild);

        // Zachowaj tylko ostatnie 50 zdarze≈Ñ
        while (log.children.length > 50) {
            log.removeChild(log.lastChild);
        }
    }

    function refreshAllData() {
        logEvent('ACTION', 'Rƒôczne od≈õwie≈ºenie wszystkich danych');
        loadAllData();
    }

    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return `${days}d ${hours}h ${mins}m`;
    }

    function sanitizeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>