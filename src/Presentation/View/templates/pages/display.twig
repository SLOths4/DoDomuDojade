<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoDomu - Wy≈õwietlacz</title>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .shadow-custom { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .bg-primary-200 { background-color: #e8f4f8; }
        .bg-primary-400 { background-color: #32b8c6; }
        .bg-beige { background-color: #f5f1ed; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .rounded-2xl { border-radius: 1rem; }
    </style>
</head>
<body x-data="{ ...layout(), ...sseHandler() }" x-init="init()" class="bg-primary-200 font-lato text-gray-800">

<!-- üîπ G√ìRNY PANEL: Data / Czas / Pogoda -->
<div x-ref="header" class="flex mx-1 my-2">
    <!-- DATA I CZAS -->
    <div x-data="clock()" x-init="init()" class="flex flex-auto bg-white h-20 rounded-2xl mr-2 shadow-custom justify-around items-center max-sm:hidden">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='18' fill='%2332b8c6'/%3E%3C/svg%3E" alt="logo" width="40" height="40">
        <div class="font-mono text-lg md:text-2xl font-extrabold flex items-center space-x-2">
            <i class="fa-solid fa-calendar text-primary-400"></i>
            <span x-text="date"></span>
        </div>
        <div class="font-mono text-lg md:text-2xl font-extrabold flex items-center space-x-2">
            <i class="fa-solid fa-clock text-primary-400"></i>
            <span x-text="time"></span>
        </div>
    </div>

    <!-- POGODA -->
    <div x-data="weather()" x-init="load()" class="flex flex-auto bg-white h-20 rounded-2xl shadow-custom justify-around items-center font-mono text-xl font-extrabold">
        <template x-if="loading">
            <p class="text-center">≈Åadowanie...</p>
        </template>
        <template x-if="error">
            <div class="bg-red-100 mx-3 text-xl border border-red-500 rounded-lg items-center space-x-2 flex flex-grow w-full">
                <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5" aria-hidden="true"></i>
                <p class="text-red-500 text-sm font-medium" x-text="error"></p>
            </div>
        </template>
        <template x-if="!loading && !error && data">
            <div class="flex w-full justify-around text-xl">
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-temperature-three-quarters" :style="`color: ${tempColor}`"></i>
                    <span x-text="`${data.temperature}¬∞C`"></span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-gauge text-primary-400"></i>
                    <span x-text="`${data.pressure} hPa`"></span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-air-freshener" :style="`color: ${data.airlyColour}`"></i>
                    <span x-text="data.airlyAdvice"></span>
                </div>
            </div>
        </template>
    </div>
</div>

<!-- üîπ G≈Å√ìWNY GRID: Tramwaje | Odliczanie + Og≈Çoszenia -->
<div class="grid grid-flow-col auto-cols-fr w-full overflow-x-auto px-1 gap-2 overflow-hidden" :style="`height: ${gridHeight}px;`">

    <!-- LEWA KOLUMNA: Tramwaje -->
    <div x-data="tramDepartures()" x-init="init()" x-ref="tramDiv" class="bg-white rounded-2xl shadow-custom py-2 px-1" :style="`height: ${tramHeight}px;`">
        <template x-if="loading">
            <p class="text-center">≈Åadowanie danych...</p>
        </template>

        <template x-if="error">
            <div class="bg-red-100 mt-3 mx-3 text-xl border border-red-500 rounded-lg flex items-center space-x-2">
                <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5"></i>
                <p class="text-red-500 text-sm font-medium" x-text="error"></p>
            </div>
        </template>

        <div id="tramGrid" x-show="!loading && !error && data.length">
            <div class="grid grid-cols-4 w-full text-center">
                <div class="pb-2 text-xs md:max-lg:text-base lg:text-lg font-bold text-primary-400">
                    <i class="fa-solid fa-train-tram"></i> Linia
                </div>
                <div class="col-span-2 pb-2 text-xs md:max-lg:text-base lg:text-lg font-bold text-primary-400">
                    <i class="fa-solid fa-location-dot"></i> Kierunek
                </div>
                <div class="pb-2 text-xs md:max-lg:text-base lg:text-lg font-bold text-primary-400">
                    <i class="fa-solid fa-clock"></i> Odjazd
                </div>
            </div>
            <template x-for="(tram, index) in data" :key="`${tram.line}-${index}`">
                <div class="demo grid grid-cols-4 w-full text-center">
                    <div class="py-2 border-t border-gray-200 text-xs md:max-lg:text-base lg:text-lg">
                        <div
                                x-text="tram.line"
                                :class="[
                                  (count[tram.line] || 'bg-white'),
                                  tram.line < 20
                                    ? 'h-6 w-6 md:max-lg:h-8 md:max-lg:w-8 lg:h-9 lg:w-9 rounded-full'
                                    : 'h-6 w-8 md:max-lg:h-8 md:max-lg:w-10 lg:h-9 lg:w-11 border'
                                ]"
                                class="font-bold inline-flex items-center justify-center"
                        ></div>
                    </div>
                    <div class="col-span-2 py-2 border-t border-gray-200 text-xs md:max-lg:text-base lg:text-lg"><a x-text="tram.direction"></a></div>
                    <div class="py-2 border-t border-gray-200 text-xs md:max-lg:text-base lg:text-lg"><a x-html="formatMinutes(tram.minutes)"></a></div>
                </div>
            </template>
        </div>
    </div>

    <!-- PRAWA KOLUMNA: Og≈Çoszenia + Pozosta≈Çe -->
    <div class="bg-white rounded-2xl shadow-custom py-2 px-2 flex flex-col">

        <!-- ODLICZANIE -->
        <div x-data="countdown()" x-init="load()">
            <template x-if="loading || data">
                <div class="bg-beige rounded-2xl m-2 p-2 shadow-custom font-mono text-xl font-extrabold text-center">
                    <p x-show="loading" class="text-center">≈Åadowanie...</p>
                    <p x-show="!loading && data" x-text="message"></p>
                </div>
            </template>

            <template x-if="error">
                <div class="bg-red-100 mt-3 mx-3 text-xl border border-red-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-red-500 text-sm font-medium" x-text="error"></p>
                </div>
            </template>

            <template x-if="info">
                <div class="bg-amber-100 mt-3 mx-3 text-xl border border-yellow-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-yellow-500 text-sm font-medium" x-text="info"></p>
                </div>
            </template>
        </div>

        <!-- CYTAT -->
        <div x-data="quote()" x-init="load()">
            <template x-if="loading || (data && data.quote)">
                <div class="bg-beige rounded-2xl m-2 p-4 shadow-custom">
                    <p x-show="loading" class="text-center text-gray-500">≈Åadowanie...</p>
                    <div x-show="!loading && data && data.quote" class="space-y-2">
                        <p class="font-mono text-lg italic text-center" x-text="data.quote.quote"></p>
                        <p class="text-right text-sm text-gray-600" x-text="data.quote.from ? `‚Äî ${data.quote.from}` : ''"></p>
                    </div>
                </div>
            </template>

            <template x-if="error">
                <div class="bg-red-100 mt-3 mx-3 text-xl border border-red-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-red-500 text-sm font-medium" x-text="error"></p>
                </div>
            </template>

            <template x-if="info">
                <div class="bg-amber-100 mt-3 mx-3 text-xl border border-yellow-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-yellow-500 text-sm font-medium" x-text="info"></p>
                </div>
            </template>
        </div>

        <!-- S≈ÅOWO DNIA -->
        <div x-data="word()" x-init="load()">
            <template x-if="loading || (data && data.word)">
                <div class="bg-beige rounded-2xl m-2 p-4 shadow-custom">
                    <p x-show="loading" class="text-center text-gray-500">≈Åadowanie...</p>
                    <div x-show="!loading && data && data.word" class="space-y-2">
                        <p class="font-mono text-lg italic text-center" x-text="data.word.word"></p>
                        <p class="font-mono text-lg italic text-center" x-text="data.word.ipa"></p>
                        <p class="font-mono text-lg italic text-center" x-text="data.word.definition"></p>
                    </div>
                </div>
            </template>

            <template x-if="error">
                <div class="bg-red-100 mt-3 mx-3 text-xl border border-red-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-red-500 text-sm font-medium" x-text="error"></p>
                </div>
            </template>

            <template x-if="info">
                <div class="bg-amber-100 mt-3 mx-3 text-xl border border-yellow-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-yellow-500 text-sm font-medium" x-text="info"></p>
                </div>
            </template>
        </div>

        <!-- EVENIMENTE -->
        <div x-data="events()" x-init="load()">
            <div class="rounded-2xl m-2">
                <p x-show="loading" class="bg-beige shadow-custom text-center text-gray-500">≈Åadowanie...</p>
                <div x-show="!loading && data.length" class="space-y-2">
                    <template x-for="(eventvar, index) in data" :key="`${eventvar.start}-${index}`">
                        <div class="my-2 py-2 bg-beige shadow-custom text-center rounded-2xl">
                            <p><i class="fa-solid fa-calendar"></i> <span class="font-mono text-lg italic text-center" x-text="eventvar.summary"></span></p>
                            <p><i class="fa-solid fa-clock"></i> <span class="font-mono text-lg italic text-center" x-text="eventvar.end ? `${eventvar.start} - ${eventvar.end}` : `${eventvar.start}`"></span></p>
                            <p><i class="fa-solid fa-align-justify"></i> <span class="font-mono text-lg italic text-center" x-text="eventvar.description"></span></p>
                        </div>
                    </template>
                </div>
            </div>

            <template x-if="error">
                <div class="bg-red-100 mt-3 mx-3 text-xl border border-red-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-red-500 text-sm font-medium" x-text="error"></p>
                </div>
            </template>

            <template x-if="info">
                <div class="bg-amber-100 mt-3 mx-3 text-xl border border-yellow-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-yellow-500 text-sm font-medium" x-text="info"></p>
                </div>
            </template>
        </div>

        <!-- OG≈ÅOSZENIA -->
        <div x-data="announcements()" x-init="load()">
            <div x-show="!error && !info" class="flex-1 overflow-y-auto py-2">
                <template x-if="loading">
                    <p class="text-center text-xl font-mono font-extrabold">≈Åadowanie...</p>
                </template>
                <template x-if="!loading && announcements">
                    <template x-for="(group, index) in grouped" :key="index">
                        <div x-show="current === index" x-transition>
                            <template x-for="(a, index) in group" :key="`${a.id}-${index}`">
                                <div class="bg-beige rounded-2xl p-3 shadow-custom mb-4">
                                    <h3 class="font-bold text-lg" x-text="a.title"></h3>
                                    <p class="text-lg" x-text="a.text"></p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <i class="fa-solid fa-user pl-2 text-primary-400"></i>
                                        <span x-text="a.author"></span>
                                    </p>
                                </div>
                            </template>
                        </div>
                    </template>
                </template>
            </div>
            <template x-if="error">
                <div class="bg-red-100 mt-3 mx-3 text-xl border border-red-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-red-500 text-sm font-medium" x-text="error"></p>
                </div>
            </template>
            <template x-if="info">
                <div class="bg-amber-100 mt-3 mx-3 text-xl border border-yellow-500 rounded-lg flex items-center space-x-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 p-2.5" aria-hidden="true"></i>
                    <p class="text-yellow-500 text-sm font-medium">Brak og≈Çosze≈Ñ do wy≈õwietlania</p>
                </div>
            </template>
        </div>
    </div>
</div>

<!-- üîπ KOMPONENTY ALPINE -->
<script>
    function sseHandler() {
        return {
            clientId: 'client_' + Math.random().toString(36).substr(2, 9) + '.' + Date.now() % 100000000,
            eventSource: null,
            init() {
                this.connect();
            },
            connect() {
                console.log('üîå Connecting to SSE stream...');
                this.eventSource = new EventSource(`/stream?clientId=${this.clientId}`);

                this.eventSource.onopen = () => {
                    console.log('‚úÖ Connected to SSE stream');
                };

                // Obs≈Çuga event√≥w
                this.eventSource.addEventListener('connected', (e) => {
                    console.log('üéØ Connected event:', e.data);
                });

                this.eventSource.addEventListener('announcement.created', (e) => {
                    console.log('üì¢ Announcement created via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-announcements'));
                });

                this.eventSource.addEventListener('announcement.updated', (e) => {
                    console.log('üì¢ Announcement updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-announcements'));
                });

                this.eventSource.addEventListener('weather_updated', (e) => {
                    console.log('‚õÖ Weather updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-weather'));
                });

                this.eventSource.addEventListener('countdown_updated', (e) => {
                    console.log('‚è≤Ô∏è Countdown updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-countdown'));
                });

                this.eventSource.addEventListener('departures_updated', (e) => {
                    console.log('üöä Departures updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-departures'));
                });

                this.eventSource.addEventListener('quote_updated', (e) => {
                    console.log('üí¨ Quote updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-quote'));
                });

                this.eventSource.addEventListener('word_updated', (e) => {
                    console.log('üìñ Word updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-word'));
                });

                this.eventSource.addEventListener('events_updated', (e) => {
                    console.log('üìÖ Events updated via SSE:', e.data);
                    window.dispatchEvent(new CustomEvent('refresh-events'));
                });

                this.eventSource.onerror = (error) => {
                    if (this.eventSource.readyState === EventSource.CLOSED) {
                        console.log('‚ùå SSE connection closed, retrying in 3s...');
                        setTimeout(() => this.connect(), 3000);
                    }
                };
            }
        }
    }

    function layout() {
        return {
            gridHeight: 0,
            tramHeight: 0,
            init() {
                this.calcGridHeight();
                window.addEventListener('resize', () => this.calcGridHeight());
                requestAnimationFrame(() => this.calcGridHeight());
            },
            calcGridHeight() {
                const headerRect = this.$refs.header?.getBoundingClientRect() || { height: 0, top: 0, bottom: 0 };
                const marginTop = parseFloat(getComputedStyle(this.$refs.header).marginTop) || 0;
                const marginBottom = parseFloat(getComputedStyle(this.$refs.header).marginBottom) || 0;
                const totalHeaderHeight = headerRect.height + marginTop + marginBottom;

                this.gridHeight = window.innerHeight - totalHeaderHeight;
                this.tramHeight = this.gridHeight - 1;
            }
        }
    }

    function clock() {
        return {
            date: '',
            time: '',
            init() {
                this.update();
                setInterval(() => this.update(), 1000);
            },
            update() {
                const now = new Date();
                this.date = now.toLocaleDateString('pl-PL');
                this.time = now.toLocaleTimeString('pl-PL');
            }
        }
    }

    function weather() {
        return {
            data: null,
            tempColor: '#000',
            error: null,
            loading: true,
            _firstLoadDone: false,
            _weatherTimeout: null,
            init() {
                this.load();
                window.addEventListener('refresh-weather', () => this.load(true));
            },
            _isDifferent(a, b) {
                if (!a || !b) return true;
                return (
                    a.temperature !== b.temperature ||
                    a.pressure !== b.pressure ||
                    a.airlyColour !== b.airlyColour ||
                    a.airlyAdvice !== b.airlyAdvice
                );
            },
            _setTempColor(t) {
                this.tempColor = t <= -10 ? '#AECBFA' :
                    t <= 0 ? '#A0F0ED' :
                        t <= 5 ? '#000000' :
                            t <= 15 ? '#FFF9A6' :
                                t <= 25 ? '#FFD1A4' : '#FFB3B3';
            },
            async load(isManual = false) {
                if (!this._firstLoadDone && !isManual) {
                    this.loading = true;
                    this.error = null;
                }
                try {
                    const res = await fetch('/display/weather', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    let json;
                    try {
                        json = await res.json();
                    } catch (e) {
                        throw new Error('Niepoprawny JSON');
                    }

                    if (!json || json.status !== 'success' || !json.data) {
                        this.error = 'B≈ÇƒÖd ≈Çadowania pogody';
                        this.loading = false;
                        this._firstLoadDone = true;
                        return;
                    }

                    const weather = json.data.weather;

                    if (this._isDifferent(this.data, weather)) {
                        this.data = weather;
                        const t = Number(weather.temperature);
                        if (!Number.isNaN(t)) this._setTempColor(t);
                    }
                    this.error = null;
                    this.loading = false;
                    this._firstLoadDone = true;
                } catch (e) {
                    console.error(e);
                    this.error = 'B≈ÇƒÖd ≈Çadowania pogody';
                    this.loading = false;
                    this._firstLoadDone = true;
                }

                if (!isManual) {
                    if (this._weatherTimeout) clearTimeout(this._weatherTimeout);
                    this._weatherTimeout = setTimeout(() => this.load(), 60000);
                }
            }
        }
    }

    function tramDepartures() {
        return {
            data: [],
            error: null,
            loading: true,
            _departuresTimeout: null,
            count: {
                '1': 'bg-pink-700',
                '2': 'bg-2',
                '3': 'bg-green-500',
                '5': 'bg-purple-700',
                '6': 'bg-6',
                '7': 'bg-teal-500',
                '8': 'bg-violet-500',
                '9': 'bg-9',
                '10': 'bg-slate-500',
                '11': 'bg-purple-400',
                '12': 'bg-12',
                '13': 'bg-amber-500',
                '14': 'bg-green-400',
                '15': 'bg-blue-400',
                '16': 'bg-red-400',
                '17': 'bg-red-400',
                '18': 'bg-18',
                '19': 'bg-19',
            },
            init() {
                this.load();
                window.addEventListener('refresh-departures', () => this.load(true));
            },
            async load(isManual = false) {
                this.error = null;
                try {
                    const res = await fetch('/display/departures', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    const json = await res.json();

                    if (json.status === 'success' && Array.isArray(json.data.departures)) {
                        const newData = json.data.departures;
                        if (JSON.stringify(this.data) !== JSON.stringify(newData)) {
                            this.data = newData;
                        }
                    } else {
                        this.error = 'B≈ÇƒÖd ≈Çadowania odjazd√≥w';
                    }
                } catch (e) {
                    console.error(e);
                    this.error = 'B≈ÇƒÖd ≈Çadowania odjazd√≥w';
                } finally {
                    this.loading = false;
                }

                if (!isManual) {
                    if (this._departuresTimeout) clearTimeout(this._departuresTimeout);
                    this._departuresTimeout = setTimeout(() => this.load(), 60000);
                }

                requestAnimationFrame(() => this.checkOverflow());
            },
            formatMinutes(min) {
                if (min === 0) return '<1';
                if (min < 60) return `${min}`;
                const h = Math.floor(min / 60), m = min % 60;
                return `${h}h ${m}`;
            },
            calcExcessTram() {
                var parentEl = this.$refs.tramDiv;
                var els = document.getElementsByClassName('demo');

                for (var i = els.length - 1; i >= 0; i--) {
                    if (!(parentEl.scrollHeight > parentEl.clientHeight || parentEl.scrollWidth > parentEl.clientWidth)) {
                        break;
                    }
                    var el = els[i];
                    if (el) {
                        el.remove();
                    }
                }
            },
            checkOverflow() {
                const elname = this.$refs.tramDiv;
                if (elname.scrollHeight > elname.clientHeight || elname.scrollWidth > elname.clientWidth) {
                    this.calcExcessTram();
                }
            }
        };
    }

    function countdown() {
        return {
            data: null,
            message: '',
            error: null,
            loading: true,
            info: null,
            _intervalId: null,
            _countdownTimeout: null,
            init() {
                this.load();
                window.addEventListener('refresh-countdown', () => this.load(true));
            },
            async load(isManual = false) {
                try {
                    const res = await fetch('/display/countdown', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const json = await res.json();

                    if (!json || typeof json !== 'object') {
                        this.loading = true;
                        this.error = 'B≈ÇƒÖd ≈Çadowania odliczania';
                        this.info = null;
                        if (this._intervalId) clearInterval(this._intervalId);
                    } else if (json.is_active === false) {
                        this.loading = false;
                        this.error = null;
                        this.info = null;
                        this.data = null;
                        this.message = '';
                        if (this._intervalId) clearInterval(this._intervalId);
                    } else if (!json.title || !json.count_to) {
                        this.loading = false;
                        this.info = 'Brak danych odliczania';
                        this.error = null;
                        this.data = null;
                        this.message = '';
                        if (this._intervalId) clearInterval(this._intervalId);
                    } else {
                        if (this.error || this.info) {
                            this.error = null;
                            this.info = null;
                        }

                        if (JSON.stringify(this.data) !== JSON.stringify(json)) {
                            this.data = json;
                            this.loading = false;
                            this.update();
                            if (this._intervalId) clearInterval(this._intervalId);
                            this._intervalId = setInterval(() => this.update(), 1000);
                        }
                    }
                } catch (e) {
                    this.error = 'B≈ÇƒÖd ≈Çadowania odliczania';
                    if (this._intervalId) clearInterval(this._intervalId);
                    this.loading = false;
                    console.error('Fetch error:', e);
                }

                if (!isManual) {
                    if (this._countdownTimeout) clearTimeout(this._countdownTimeout);
                    this._countdownTimeout = setTimeout(() => this.load(), 60000);
                }
            },
            update() {
                if (!this.data) return;
                const end = new Date(this.data.count_to * 1000);
                const diff = end - Date.now();
                if (diff <= 0) {
                    this.message = 'Zako≈Ñczono!';
                    if (this._intervalId) {
                        clearInterval(this._intervalId);
                        this._intervalId = null;
                    }
                    return;
                }
                const d = Math.floor(diff / 86400000),
                    h = Math.floor(diff / 3600000) % 24,
                    m = Math.floor(diff / 60000) % 60,
                    s = Math.floor(diff / 1000) % 60;

                let odmianadni = d === 1 ? '1 dzie≈Ñ' : `${d} dni`;
                let odmianagodzin = h === 1 ? '1 godzina' : [2,3,4,22,23].includes(h) ? `${h} godziny` : `${h} godzin`;
                let odmianaminut = m === 1 ? '1 minuta' : [2,3,4,22,23,24,32,33,34,42,43,44,52,53,54].includes(m) ? `${m} minuty` : `${m} minut`;
                let odmianasekund = s === 1 ? '1 sekunda' : [2,3,4,22,23,24,32,33,34,42,43,44,52,53,54].includes(s) ? `${s} sekundy` : `${s} sekund`;

                this.message = `Do ${this.data.title} : ${odmianadni} ${odmianagodzin} ${odmianaminut} ${odmianasekund}`;
            }
        }
    }

    function quote() {
        return {
            data: null,
            error: null,
            loading: true,
            info: null,
            _quoteTimeout: null,
            init() {
                this.load();
                window.addEventListener('refresh-quote', () => this.load(true));
            },
            async load(isManual = false) {
                try {
                    const res = await fetch('/display/quote', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const json = await res.json();

                    if (!json || typeof json !== 'object') {
                        this.loading = false;
                        this.error = 'B≈ÇƒÖd ≈Çadowania cytatu';
                        this.info = null;
                        this.data = null;
                    } else if (json.is_active === false) {
                        this.loading = false;
                        this.error = null;
                        this.info = null;
                        this.data = null;
                    } else if (!json.quote) {
                        this.loading = false;
                        this.info = 'Brak dostƒôpnego cytatu';
                        this.error = null;
                        this.data = null;
                    } else {
                        if (this.error || this.info) {
                            this.error = null;
                            this.info = null;
                        }

                        if (JSON.stringify(this.data) !== JSON.stringify(json)) {
                            this.data = json;
                            this.loading = false;
                        }
                    }
                } catch (e) {
                    this.error = 'B≈ÇƒÖd ≈Çadowania cytatu';
                    this.loading = false;
                    console.error('Fetch error:', e);
                }

                if (!isManual) {
                    if (this._quoteTimeout) clearTimeout(this._quoteTimeout);
                    this._quoteTimeout = setTimeout(() => this.load(), 60000);
                }
            }
        }
    }

    function word() {
        return {
            data: null,
            error: null,
            loading: true,
            info: null,
            _wordTimeout: null,
            init() {
                this.load();
                window.addEventListener('refresh-word', () => this.load(true));
            },
            async load(isManual = false) {
                try {
                    const res = await fetch('/display/word', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const json = await res.json();

                    if (!json || typeof json !== 'object') {
                        this.loading = false;
                        this.error = 'B≈ÇƒÖd ≈Çadowania s≈Çowa dnia';
                        this.info = null;
                        this.data = null;
                    } else if (json.is_active === false) {
                        this.loading = false;
                        this.error = null;
                        this.info = null;
                        this.data = null;
                    } else if (!json.word) {
                        this.loading = false;
                        this.info = 'Brak dostƒôpnego s≈Çowa dnia';
                        this.error = null;
                        this.data = null;
                    } else {
                        if (this.error || this.info) {
                            this.error = null;
                            this.info = null;
                        }

                        if (JSON.stringify(this.data) !== JSON.stringify(json)) {
                            this.data = json;
                            this.loading = false;
                        }
                    }
                } catch (e) {
                    this.error = 'B≈ÇƒÖd ≈Çadowania s≈Çowa';
                    this.loading = false;
                    console.error('Fetch error:', e);
                }

                if (!isManual) {
                    if (this._wordTimeout) clearTimeout(this._wordTimeout);
                    this._wordTimeout = setTimeout(() => this.load(), 60000);
                }
            }
        }
    }

    function events() {
        return {
            data: [],
            error: null,
            loading: true,
            info: null,
            _eventsTimeout: null,
            init() {
                this.load();
                window.addEventListener('refresh-events', () => this.load(true));
            },
            async load(isManual = false) {
                try {
                    const res = await fetch('/display/events', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const json = await res.json();

                    if (!json || typeof json !== 'object') {
                        this.loading = false;
                        this.error = 'B≈ÇƒÖd ≈Çadowania wydarze≈Ñ';
                        this.info = null;
                        this.data = [];
                    } else if (json.is_active === false) {
                        this.loading = false;
                        this.error = null;
                        this.info = null;
                        this.data = [];
                    } else if (!Array.isArray(json.events) || !json.events.length) {
                        this.loading = false;
                        this.info = 'Brak dostƒôpnego wydarzenia';
                        this.error = null;
                        this.data = [];
                    } else {
                        if (this.error || this.info) {
                            this.error = null;
                            this.info = null;
                        }
                        if (JSON.stringify(this.data) !== JSON.stringify(json.events)) {
                            this.data = json.events;
                            this.loading = false;
                        }
                    }
                } catch (e) {
                    this.error = 'B≈ÇƒÖd ≈Çadowania wydarze≈Ñ';
                    this.loading = false;
                    console.error('Fetch error:', e);
                } finally {
                    this.loading = false;
                }

                if (!isManual) {
                    if (this._eventsTimeout) clearTimeout(this._eventsTimeout);
                    this._eventsTimeout = setTimeout(() => this.load(), 60000);
                }
            }
        }
    }

    function announcements() {
        return {
            announcements: [],
            grouped: [],
            current: 0,
            error: null,
            loading: true,
            info: null,
            _rotateIntervalId: null,
            _announcementsTimeout: null,
            init() {
                this.load();
                window.addEventListener('refresh-announcements', () => this.load(true));
            },
            async load(isManual = false) {
                try {
                    const res = await fetch('/display/announcements', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    const json = await res.json();

                    if (!json || json.status !== 'success' || typeof json.data !== 'object') {
                        this.loading = false;
                        this.error = 'B≈ÇƒÖd ≈Çadowania og≈Çosze≈Ñ';
                        this.info = null;
                        if (this._rotateIntervalId) clearInterval(this._rotateIntervalId);
                        return;
                    }

                    if (json.data.is_active === false) {
                        this.loading = false;
                        this.error = null;
                        this.info = null;
                        this.announcements = [];
                        this.grouped = [];
                        if (this._rotateIntervalId) clearInterval(this._rotateIntervalId);
                        return;
                    }

                    const list = Array.isArray(json.data.announcements) ? json.data.announcements : [];

                    if (!list.length) {
                        this.loading = false;
                        this.info = 'Brak danych og≈Çosze≈Ñ';
                        this.error = null;
                        this.announcements = [];
                        this.grouped = [];
                        if (this._rotateIntervalId) clearInterval(this._rotateIntervalId);
                        return;
                    }

                    if (this.error || this.info) {
                        this.error = null;
                        this.info = null;
                    }

                    if (JSON.stringify(this.announcements) === JSON.stringify(list)) {
                        this.loading = false;
                    } else {
                        this.announcements = list;
                        this.loading = false;
                        this.grouped = this.chunk(list, 4);
                        this.current = 0;
                        if (this._rotateIntervalId) clearInterval(this._rotateIntervalId);
                        this.rotate();
                    }
                } catch (e) {
                    this.error = 'B≈ÇƒÖd ≈Çadowania og≈Çosze≈Ñ';
                    this.loading = false;
                    if (this._rotateIntervalId) clearInterval(this._rotateIntervalId);
                    console.error(e);
                }

                if (!isManual) {
                    if (this._announcementsTimeout) clearTimeout(this._announcementsTimeout);
                    this._announcementsTimeout = setTimeout(() => this.load(), 300000);
                }
            },
            chunk(arr, size) {
                return Array.from({ length: Math.ceil(arr.length / size) },
                    (_, i) => arr.slice(i * size, i * size + size));
            },
            rotate() {
                this._rotateIntervalId = setInterval(() => {
                    this.current = (this.current + 1) % this.grouped.length;
                }, 8000);
            }
        }
    }
</script>
</body>
</html>